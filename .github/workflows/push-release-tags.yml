on:
  push:
    tags:
      - "release-*"

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    name: Build and deploy
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: '13'
      - name: Package application
        run: |
          mvn -B clean package
      - name: Extract release version
        id: extract_release_version
        run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d - -f 2)
      - name: Create Docker image
        uses: VaultVulp/gp-docker-action@1.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          image-name: flightlog
          image-tag: "${{ steps.extract_release_version.outputs.VERSION }}"
      - name: Create GitHub release        
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          title: "${{ steps.extract_release_version.outputs.VERSION }}"
          automatic_release_tag: "release-${{ steps.extract_release_version.outputs.VERSION }}"
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
